<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voz a Texto</title>
    <style>
        #status {
            font-weight: bold;
            color: red;
        }
        .chat-container {
            width: 100%;
            max-width: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .message {
            background: #dcf8c6;
            padding: 5px 10px;
            border-radius: 10px;
            margin: 5px 0;
            align-self: flex-start;
            display: flex;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }
        .listening {
            color: green;
        }
        .message label {
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }
        .message input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <button id="toggleBtn">Activar Voz</button>
    <span id="status">Micrófono apagado</span>
    <div class="chat-container" id="chat"></div>
    <button id="exportBtn">Exportar</button>
    <textarea id="exportArea" rows="5" cols="40"></textarea>
    <button id="speakBtn">Leer en Voz Alta</button>
    <button id="resetBtn">Reiniciar</button>

    <script>
        let recognition;
        let isListening = false;
        let chatContainer = document.getElementById('chat');
        let statusIndicator = document.getElementById('status');
        let messageId = parseInt(localStorage.getItem('messageId')) || 0;

        function saveToLocalStorage() {
            let messages = document.querySelectorAll('.message');
            let jsonData = [];
            messages.forEach(msg => {
                let id = parseInt(msg.getAttribute('data-id'));
                let text = msg.querySelector('span').innerText;
                let disabled = !msg.querySelector('input').checked;
                jsonData.push({ id, text, disabled });
            });
            jsonData.sort((a, b) => a.id - b.id); // Mantener el orden de los IDs
            localStorage.setItem('savedMessages', JSON.stringify(jsonData));
            localStorage.setItem('messageId', messageId);
        }

        function addMessage(text, id, enabled = true, save = true) {
            let messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.setAttribute('data-id', id);
            
            let label = document.createElement('label');
            let checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = enabled;
            checkbox.classList.add('msg-checkbox');
            
            let textSpan = document.createElement('span');
            textSpan.innerText = text;
            
            label.appendChild(checkbox);
            label.appendChild(textSpan);
            messageElement.appendChild(label);
            
            label.addEventListener('click', () => {
                checkbox.checked = !checkbox.checked;
                saveToLocalStorage();
            });
            
            chatContainer.prepend(messageElement);
            if (save) saveToLocalStorage();
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'es-ES';

            recognition.onresult = function(event) {
                let transcript = event.results[event.resultIndex][0].transcript;
                addMessage(transcript, messageId++);
            };
            recognition.onend = function() {
                if (isListening) {
                    recognition.start();
                }
            };
        } else {
            alert("Tu navegador no soporta el reconocimiento de voz.");
        }

        document.getElementById('toggleBtn').addEventListener('click', function() {
            if (!isListening) {
                recognition.start();
                this.innerText = 'Desactivar Voz';
                statusIndicator.innerText = 'Escuchando...';
                statusIndicator.classList.add('listening');
            } else {
                recognition.stop();
                this.innerText = 'Activar Voz';
                statusIndicator.innerText = 'Micrófono apagado';
                statusIndicator.classList.remove('listening');
            }
            isListening = !isListening;
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            let messages = document.querySelectorAll('.message');
            let textOutput = [];
            let orderedMessages = Array.from(messages).map(msg => {
                return {
                    id: parseInt(msg.getAttribute('data-id')),
                    text: msg.querySelector('span').innerText,
                    enabled: msg.querySelector('input').checked
                };
            }).filter(msg => msg.enabled);
            
            orderedMessages.sort((a, b) => a.id - b.id);
            
            orderedMessages.forEach(msg => {
                textOutput.push(msg.text);
            });
            
            document.getElementById('exportArea').value = textOutput.join('\n');
            chatContainer.innerHTML = ''; // Vaciar la zona visual
        });

        document.getElementById('speakBtn').addEventListener('click', function() {
            let text = document.getElementById('exportArea').value;
            if (text.trim() !== '') {
                let speech = new SpeechSynthesisUtterance(text);
                speech.lang = 'es-ES';
                window.speechSynthesis.speak(speech);
            }
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            localStorage.removeItem('savedMessages');
            chatContainer.innerHTML = '';
            saveToLocalStorage();
        });
    </script>
</body>
</html>
